<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cosmic Oracle - Personalized Astrology</title>
  <script src="js/reading.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Georgia', serif;
            background: linear-gradient(135deg, #1a0033 0%, #2d1b4e 50%, #1a0033 100%);
            color: #f0e6ff;
            min-height: 100vh;
            padding: 20px;
            position: relative;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: 
                radial-gradient(2px 2px at 20% 30%, white, transparent),
                radial-gradient(2px 2px at 60% 70%, white, transparent),
                radial-gradient(1px 1px at 50% 50%, white, transparent);
            background-size: 200% 200%;
            animation: twinkle 4s ease-in-out infinite;
            opacity: 0.5;
            pointer-events: none;
        }
        
        @keyframes twinkle {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 0.8; }
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }
        
        header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        h1 {
            font-size: 3rem;
            color: #ffd700;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 1.2rem;
            color: #d4a5ff;
            font-style: italic;
        }
        
        .user-status {
            background: rgba(45, 27, 78, 0.6);
            border: 2px solid #8b4fcc;
            border-radius: 15px;
            padding: 15px 25px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        .status-badge.free {
            background: rgba(139, 79, 204, 0.3);
            border: 2px solid #8b4fcc;
        }
        
        .status-badge.premium {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            color: #1a0033;
            border: 2px solid #ffd700;
        }
        
        .readings-left {
            color: #d4a5ff;
            font-size: 0.9rem;
        }
        
        .upgrade-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            color: #1a0033;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .upgrade-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.4);
        }
        
        .input-section {
            background: rgba(45, 27, 78, 0.6);
            backdrop-filter: blur(10px);
            border: 2px solid #8b4fcc;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(139, 79, 204, 0.3);
        }
        
        .premium-badge {
            display: inline-block;
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            color: #1a0033;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 0.7rem;
            font-weight: bold;
            margin-left: 8px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #d4a5ff;
            font-weight: bold;
        }
        
        select, input, textarea {
            width: 100%;
            padding: 12px;
            background: rgba(26, 0, 51, 0.8);
            border: 2px solid #8b4fcc;
            border-radius: 10px;
            color: #f0e6ff;
            font-size: 1rem;
            font-family: 'Georgia', serif;
        }
        
        textarea {
            min-height: 80px;
            resize: vertical;
        }
        
        select:focus, input:focus, textarea:focus {
            outline: none;
            border-color: #ffd700;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
        }
        
        button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #8b4fcc 0%, #6b2fb5 100%);
            border: none;
            border-radius: 10px;
            color: #fff;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        button:hover {
            background: linear-gradient(135deg, #9d5fe0 0%, #7d3fc9 100%);
            transform: translateY(-2px);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .reading-type-pills {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        
        .pill {
            padding: 10px 18px;
            background: rgba(26, 0, 51, 0.8);
            border: 2px solid #8b4fcc;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #d4a5ff;
            font-size: 0.95rem;
            position: relative;
        }
        
        .pill.locked {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .pill.locked::after {
            content: 'üîí';
            margin-left: 5px;
        }
        
        .pill.active {
            background: linear-gradient(135deg, #8b4fcc 0%, #6b2fb5 100%);
            color: #fff;
            border-color: #ffd700;
        }
        
        .pill:not(.locked):hover {
            border-color: #ffd700;
            transform: translateY(-2px);
        }
        
        .mood-pills {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
        }
        
        .mood-pills .pill {
            text-align: center;
            padding: 12px;
        }
        
        .results {
            display: none;
        }
        
        .card {
            background: rgba(45, 27, 78, 0.6);
            backdrop-filter: blur(10px);
            border: 2px solid #8b4fcc;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
        }
        
        .card h2 {
            color: #ffd700;
            text-align: center;
            margin-bottom: 20px;
            font-size: 2rem;
        }
        
        .card-display {
            text-align: center;
            padding: 40px;
            background: rgba(139, 79, 204, 0.2);
            border-radius: 15px;
            border: 3px solid #8b4fcc;
            margin: 20px 0;
        }
        
        .card-display .symbol {
            font-size: 5rem;
            margin-bottom: 20px;
        }
        
        .card-display .name {
            color: #ffd700;
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .card-display .element {
            color: #d4a5ff;
            font-size: 1.2rem;
        }
        
        .horoscope-text {
            line-height: 1.8;
            font-size: 1.1rem;
            color: #f0e6ff;
            margin-bottom: 15px;
            white-space: pre-line;
        }
        
        .compatibility-score {
            text-align: center;
            margin: 20px 0;
        }
        
        .score-circle {
            display: inline-flex;
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(135deg, #8b4fcc 0%, #6b2fb5 100%);
            border: 4px solid #ffd700;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            font-weight: bold;
            color: #ffd700;
            margin: 10px auto;
        }
        
        .alert-box {
            padding: 15px;
            margin: 15px 0;
            border-radius: 10px;
        }
        
        .alert-box.warning {
            background: rgba(255, 193, 7, 0.15);
            border: 2px solid #ffc107;
        }
        
        .alert-box.positive {
            background: rgba(76, 175, 80, 0.15);
            border: 2px solid #4caf50;
        }
        
        .premium-section {
            background: rgba(255, 215, 0, 0.1);
            border: 2px solid #ffd700;
            border-radius: 15px;
            padding: 25px;
            margin-top: 30px;
            position: relative;
        }
        
        .premium-section::before {
            content: 'üëë PREMIUM';
            position: absolute;
            top: -15px;
            left: 20px;
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            color: #1a0033;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
        }
        
        .premium-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .premium-option {
            background: rgba(26, 0, 51, 0.6);
            border: 2px solid #8b4fcc;
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .premium-option:hover {
            border-color: #ffd700;
            transform: translateY(-3px);
        }
        
        .premium-option.selected {
            border-color: #ffd700;
            background: rgba(255, 215, 0, 0.1);
        }
        
        .premium-option h3 {
            color: #ffd700;
            margin-bottom: 10px;
        }
        
        .premium-option p {
            color: #d4a5ff;
            font-size: 0.9rem;
            margin-bottom: 10px;
            line-height: 1.5;
        }
        
        .price {
            color: #ffd700;
            font-weight: bold;
            font-size: 1.3rem;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: linear-gradient(135deg, #2d1b4e 0%, #1a0033 100%);
            border: 2px solid #ffd700;
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            position: relative;
        }
        
        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: #ffd700;
            font-size: 2rem;
            cursor: pointer;
            width: auto;
            padding: 0;
        }
        
        .api-key-setup {
            background: rgba(255, 215, 0, 0.1);
            border: 2px solid #ffd700;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .api-key-setup h3 {
            color: #ffd700;
            margin-bottom: 15px;
        }
        
        .api-key-setup ol {
            color: #d4a5ff;
            margin-left: 20px;
            line-height: 1.8;
        }
        
        .api-key-setup a {
            color: #ffd700;
            text-decoration: none;
        }
        
        .api-key-setup a:hover {
            text-decoration: underline;
        }
        
        @media (max-width: 768px) {
            h1 { font-size: 2rem; }
            .reading-type-pills { flex-direction: column; }
            .pill { width: 100%; text-align: center; }
            .user-status { flex-direction: column; text-align: center; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>‚ú® Cosmic Oracle ‚ú®</h1>
            <p class="subtitle">Your Personalized Celestial Guide</p>
        </header>

        <div class="user-status">
            <div>
                <span class="status-badge" id="statusBadge">
                    <span id="statusIcon">‚≠ê</span>
                    <span id="statusText">Free Tier</span>
                </span>
                <span class="readings-left" id="readingsLeft">3 readings left today</span>
            </div>
            <button class="upgrade-btn" id="upgradeBtn" onclick="showUpgradeModal()">
                Upgrade to Premium ‚ú®
            </button>
        </div>

        <!-- Removed API key setup - now handled by backend -->


        <div class="input-section">
            <div class="form-group">
                <label>Choose Your Reading Type:</label>
                <div class="reading-type-pills">
                    <div class="pill active" data-type="daily" onclick="selectReadingType('daily')">
                        ‚ú® Daily Reading
                    </div>
                    <div class="pill" data-type="mood" onclick="selectReadingType('mood')">
                        üòå Mood-Based
                    </div>
                    <div class="pill" data-type="event" onclick="selectReadingType('event')">
                        üìç Event-Specific
                    </div>
                    <div class="pill locked" data-type="compatibility" onclick="selectReadingType('compatibility')">
                        ü§ù Quick Compatibility <span class="premium-badge">Pro</span>
                    </div>
                    <div class="pill locked" data-type="sync" onclick="selectReadingType('sync')">
                        üìÜ Sync Calendar <span class="premium-badge">Pro</span>
                    </div>
                    <div class="pill locked" data-type="relationship" onclick="selectReadingType('relationship')">
                        üíï Deep Report <span class="premium-badge">Pro</span>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label for="zodiac">Your Zodiac Sign:</label>
                <select id="zodiac">
                    <option value="">Select your sign...</option>
                    <option value="aries">‚ôà Aries</option>
                    <option value="taurus">‚ôâ Taurus</option>
                    <option value="gemini">‚ôä Gemini</option>
                    <option value="cancer">‚ôã Cancer</option>
                    <option value="leo">‚ôå Leo</option>
                    <option value="virgo">‚ôç Virgo</option>
                    <option value="libra">‚ôé Libra</option>
                    <option value="scorpio">‚ôè Scorpio</option>
                    <option value="sagittarius">‚ôê Sagittarius</option>
                    <option value="capricorn">‚ôë Capricorn</option>
                    <option value="aquarius">‚ôí Aquarius</option>
                    <option value="pisces">‚ôì Pisces</option>
                </select>
            </div>

            <!-- Mood Selection -->
            <div id="moodInput" style="display: none;">
                <div class="form-group">
                    <label>How are you feeling right now?</label>
                    <div class="mood-pills">
                        <div class="pill" data-mood="anxious" onclick="selectMood('anxious')">üò∞ Anxious</div>
                        <div class="pill" data-mood="motivated" onclick="selectMood('motivated')">üí™ Motivated</div>
                        <div class="pill" data-mood="heartbroken" onclick="selectMood('heartbroken')">üíî Heartbroken</div>
                        <div class="pill" data-mood="calm" onclick="selectMood('calm')">üßò Calm</div>
                        <div class="pill" data-mood="confused" onclick="selectMood('confused')">ü§î Confused</div>
                        <div class="pill" data-mood="excited" onclick="selectMood('excited')">üéâ Excited</div>
                        <div class="pill" data-mood="overwhelmed" onclick="selectMood('overwhelmed')">üòì Overwhelmed</div>
                        <div class="pill" data-mood="hopeful" onclick="selectMood('hopeful')">üåü Hopeful</div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="lifeArea">What do you need guidance on?</label>
                    <select id="lifeArea">
                        <option value="general">General Guidance</option>
                        <option value="love">üíï Love & Relationships</option>
                        <option value="money">üí∞ Money & Finances</option>
                        <option value="healing">üåø Healing & Self-Care</option>
                        <option value="confidence">‚ú® Confidence & Self-Worth</option>
                        <option value="boundaries">üõ°Ô∏è Boundaries & Protection</option>
                        <option value="career">üíº Career & Purpose</option>
                        <option value="creativity">üé® Creativity & Expression</option>
                    </select>
                </div>
            </div>

            <!-- Event Input -->
            <div id="eventInput" style="display: none;">
                <div class="form-group">
                    <label for="eventType">What's coming up?</label>
                    <select id="eventType">
                        <option value="">Select event type...</option>
                        <option value="date">üíï Date / Romantic Outing</option>
                        <option value="interview">üíº Job Interview</option>
                        <option value="conflict">‚ö° Difficult Conversation</option>
                        <option value="travel">‚úàÔ∏è Travel / Trip</option>
                        <option value="presentation">üé§ Presentation</option>
                        <option value="meeting">ü§ù Important Meeting</option>
                    </select>
                </div>
            </div>

            <!-- Compatibility Input (Premium) -->
            <div id="compatibilityInput" style="display: none;">
                <div class="form-group">
                    <label for="compatibilitySign">Their Zodiac Sign:</label>
                    <select id="compatibilitySign">
                        <option value="">Select their sign...</option>
                        <option value="aries">‚ôà Aries</option>
                        <option value="taurus">‚ôâ Taurus</option>
                        <option value="gemini">‚ôä Gemini</option>
                        <option value="cancer">‚ôã Cancer</option>
                        <option value="leo">‚ôå Leo</option>
                        <option value="virgo">‚ôç Virgo</option>
                        <option value="libra">‚ôé Libra</option>
                        <option value="scorpio">‚ôè Scorpio</option>
                        <option value="sagittarius">‚ôê Sagittarius</option>
                        <option value="capricorn">‚ôë Capricorn</option>
                        <option value="aquarius">‚ôí Aquarius</option>
                        <option value="pisces">‚ôì Pisces</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="relationshipType">What's your relationship?</label>
                    <select id="relationshipType">
                        <option value="romantic">üíï Romantic</option>
                        <option value="friend">ü§ù Friend</option>
                        <option value="family">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family</option>
                        <option value="coworker">üíº Coworker</option>
                    </select>
                </div>
            </div>

            <!-- Premium Partner Input -->
            <div id="partnerInput" style="display: none;">
                <div class="form-group">
                    <label for="partnerZodiac">Partner's Zodiac Sign:</label>
                    <select id="partnerZodiac">
                        <option value="">Select their sign...</option>
                        <option value="aries">‚ôà Aries</option>
                        <option value="taurus">‚ôâ Taurus</option>
                        <option value="gemini">‚ôä Gemini</option>
                        <option value="cancer">‚ôã Cancer</option>
                        <option value="leo">‚ôå Leo</option>
                        <option value="virgo">‚ôç Virgo</option>
                        <option value="libra">‚ôé Libra</option>
                        <option value="scorpio">‚ôè Scorpio</option>
                        <option value="sagittarius">‚ôê Sagittarius</option>
                        <option value="capricorn">‚ôë Capricorn</option>
                        <option value="aquarius">‚ôí Aquarius</option>
                        <option value="pisces">‚ôì Pisces</option>
                    </select>
                </div>
            </div>

            <button id="generateBtn" onclick="generateReading()" style="margin-top: 20px;">
                Reveal Your Reading
            </button>
        </div>

        <div class="premium-section">
            <h2 style="color: #ffd700; margin-bottom: 20px; margin-top: 10px;">‚ú® Upgrade to Premium</h2>
            <p style="color: #d4a5ff; text-align: center; margin-bottom: 25px; font-size: 1.1rem;">
                Unlock unlimited AI-powered readings, compatibility analysis, and relationship insights!
            </p>
            <div class="premium-options">
                <div class="premium-option" onclick="selectPlan('monthly')" data-plan="monthly">
                    <h3>üí´ Monthly Premium</h3>
                    <p style="margin: 15px 0;">
                        ‚ú® Unlimited AI-powered readings<br>
                        ü§ù Compatibility analysis<br>
                        üìÜ Weekly relationship sync calendars<br>
                        üíï Deep relationship reports<br>
                        üéØ Event-specific guidance<br>
                        üòå Mood-based personalized readings
                    </p>
                    <p class="price">$4.99<span style="font-size: 0.9rem; color: #d4a5ff;">/month</span></p>
                </div>
                <div class="premium-option" onclick="selectPlan('annual')" data-plan="annual">
                    <h3>üåü Annual Premium</h3>
                    <p style="margin: 15px 0;">
                        ‚ú® Everything in Monthly, PLUS:<br>
                        üé® AI-generated zodiac card images<br>
                        üìä Yearly forecast reports<br>
                        üéÅ Early access to new features<br>
                        üíé Priority customer support<br>
                        üì• Export readings as PDF
                    </p>
                    <p class="price">$39.99<span style="font-size: 0.9rem; color: #d4a5ff;">/year</span></p>
                    <p style="color: #4caf50; font-weight: bold; margin-top: 10px;">üí∞ Save 33% - Best Value!</p>
                </div>
            </div>
            <button onclick="processUpgrade()" style="margin-top: 25px; background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%); color: #1a0033; font-size: 1.2rem;">
                Continue to Payment ‚Üí
            </button>
            <p style="text-align: center; color: #d4a5ff; font-size: 0.85rem; margin-top: 15px;">
                üîí Secure payment powered by Stripe ‚Ä¢ Cancel anytime ‚Ä¢ 7-day money-back guarantee
            </p>
        </div>

        <div id="results" class="results">
            <div class="card">
                <h2 id="signTitle"></h2>
                <div id="cardDisplay"></div>
                <div id="horoscopeText"></div>
            </div>
        </div>
    </div>

    <!-- Upgrade Modal -->
    <div id="upgradeModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeUpgradeModal()">√ó</button>
            <h2 style="color: #ffd700; margin-bottom: 20px;">üîí Premium Feature</h2>
            <p style="color: #d4a5ff; line-height: 1.8; margin-bottom: 20px;">
                This reading type requires a Premium subscription. Upgrade now for unlimited access to:
            </p>
            <ul style="color: #d4a5ff; margin-left: 20px; margin-bottom: 25px; line-height: 1.8;">
                <li>AI-powered personalized readings</li>
                <li>Relationship compatibility analysis</li>
                <li>Weekly sync calendars</li>
                <li>Deep relationship reports</li>
                <li>Unlimited daily readings</li>
            </ul>
            <button onclick="closeUpgradeModal(); document.querySelector('.premium-section').scrollIntoView({behavior: 'smooth'});" 
                    style="background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%); color: #1a0033;">
                See Premium Plans
            </button>
        </div>
    </div>

    <script>
        // User state management
        let userState = {
            isPremium: false,
            readingsToday: 0,
            maxFreeReadings: 3,
            selectedPlan: null
        };

        let selectedReadingType = 'daily';
        let selectedMood = null;

        const zodiacData = {
            aries: { name: "Aries", symbol: "‚ôà", dates: "March 21 - April 19", element: "Fire", planet: "Mars" },
            taurus: { name: "Taurus", symbol: "‚ôâ", dates: "April 20 - May 20", element: "Earth", planet: "Venus" },
            gemini: { name: "Gemini", symbol: "‚ôä", dates: "May 21 - June 20", element: "Air", planet: "Mercury" },
            cancer: { name: "Cancer", symbol: "‚ôã", dates: "June 21 - July 22", element: "Water", planet: "Moon" },
            leo: { name: "Leo", symbol: "‚ôå", dates: "July 23 - August 22", element: "Fire", planet: "Sun" },
            virgo: { name: "Virgo", symbol: "‚ôç", dates: "August 23 - September 22", element: "Earth", planet: "Mercury" },
            libra: { name: "Libra", symbol: "‚ôé", dates: "September 23 - October 22", element: "Air", planet: "Venus" },
            scorpio: { name: "Scorpio", symbol: "‚ôè", dates: "October 23 - November 21", element: "Water", planet: "Pluto" },
            sagittarius: { name: "Sagittarius", symbol: "‚ôê", dates: "November 22 - December 21", element: "Fire", planet: "Jupiter" },
            capricorn: { name: "Capricorn", symbol: "‚ôë", dates: "December 22 - January 19", element: "Earth", planet: "Saturn" },
            aquarius: { name: "Aquarius", symbol: "‚ôí", dates: "January 20 - February 18", element: "Air", planet: "Uranus" },
            pisces: { name: "Pisces", symbol: "‚ôì", dates: "February 19 - March 20", element: "Water", planet: "Neptune" }
        };

        // Initialize app
        function init() {
            loadUserState();
            
            // Check if user just completed payment
            checkPaymentSuccess();
            
            updateUI();
        }

        function checkPaymentSuccess() {
            // Check URL for success parameter
            const urlParams = new URLSearchParams(window.location.search);
            
            if (urlParams.get('success') === 'true') {
                // Payment successful! Activate premium
                userState.isPremium = true;
                saveUserState();
                
                // Show success message
                alert('üéâ Welcome to Premium! All features are now unlocked!\n\nYour subscription is active and you have unlimited access to AI-powered readings.');
                
                // Clean up URL
                window.history.replaceState({}, document.title, window.location.pathname);
                
                // Scroll to top
                window.scrollTo(0, 0);
            }
            
            if (urlParams.get('canceled') === 'true') {
                // Payment was canceled
                alert('Payment was canceled. No charges were made.');
                
                // Clean up URL
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }

        function loadUserState() {
            const stored = localStorage.getItem('cosmicOracleUser');
            if (stored) {
                const data = JSON.parse(stored);
                userState.isPremium = data.isPremium || false;
                userState.readingsToday = data.readingsToday || 0;
                
                // Reset readings if it's a new day
                const lastDate = data.lastDate || '';
                const today = new Date().toDateString();
                if (lastDate !== today) {
                    userState.readingsToday = 0;
                }
            }
        }

        function saveUserState() {
            const data = {
                isPremium: userState.isPremium,
                readingsToday: userState.readingsToday,
                lastDate: new Date().toDateString()
            };
            localStorage.setItem('cosmicOracleUser', JSON.stringify(data));
        }

        function updateUI() {
            const statusBadge = document.getElementById('statusBadge');
            const statusIcon = document.getElementById('statusIcon');
            const statusText = document.getElementById('statusText');
            const readingsLeft = document.getElementById('readingsLeft');
            const upgradeBtn = document.getElementById('upgradeBtn');

            if (userState.isPremium) {
                statusBadge.className = 'status-badge premium';
                statusIcon.textContent = 'üëë';
                statusText.textContent = 'Premium Member';
                readingsLeft.textContent = 'Unlimited AI-powered readings';
                upgradeBtn.style.display = 'none';
                
                // Unlock premium features
                document.querySelectorAll('.pill.locked').forEach(pill => {
                    pill.classList.remove('locked');
                });
            } else {
                statusBadge.className = 'status-badge free';
                statusIcon.textContent = '‚≠ê';
                statusText.textContent = 'Free Tier';
                const left = userState.maxFreeReadings - userState.readingsToday;
                readingsLeft.textContent = `${left} reading${left !== 1 ? 's' : ''} left today`;
                upgradeBtn.style.display = 'block';
            }
        }

        function selectReadingType(type) {
            const pill = document.querySelector(`[data-type="${type}"]`);
            
            // Check if premium feature and user is not premium
            if (pill.classList.contains('locked') && !userState.isPremium) {
                showUpgradeModal();
                return;
            }

            selectedReadingType = type;
            
            document.querySelectorAll('.reading-type-pills .pill').forEach(p => {
                p.classList.remove('active');
            });
            pill.classList.add('active');

            // Hide all conditional inputs
            document.getElementById('moodInput').style.display = 'none';
            document.getElementById('eventInput').style.display = 'none';
            document.getElementById('compatibilityInput').style.display = 'none';
            document.getElementById('partnerInput').style.display = 'none';

            // Show relevant inputs
            if (type === 'mood') {
                document.getElementById('moodInput').style.display = 'block';
            } else if (type === 'event') {
                document.getElementById('eventInput').style.display = 'block';
            } else if (type === 'compatibility') {
                document.getElementById('compatibilityInput').style.display = 'block';
            } else if (type === 'relationship' || type === 'sync') {
                document.getElementById('partnerInput').style.display = 'block';
            }
        }

        function selectMood(mood) {
            selectedMood = mood;
            document.querySelectorAll('.mood-pills .pill').forEach(pill => {
                pill.classList.remove('active');
            });
            document.querySelector(`[data-mood="${mood}"]`).classList.add('active');
        }

        function selectPlan(plan) {
            userState.selectedPlan = plan;
            document.querySelectorAll('.premium-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            document.querySelector(`[data-plan="${plan}"]`).classList.add('selected');
        }

        function showUpgradeModal() {
            document.getElementById('upgradeModal').style.display = 'flex';
        }

        function closeUpgradeModal() {
            document.getElementById('upgradeModal').style.display = 'none';
        }

        function processUpgrade() {
            if (!userState.selectedPlan) {
                alert('Please select a plan first');
                return;
            }

            // REPLACE THESE WITH YOUR ACTUAL STRIPE PAYMENT LINKS
            const paymentLinks = {
                monthly: 'https://buy.stripe.com/dRm7sNfnebJNa0j9p8fAc02',
                annual: 'https://buy.stripe.com/aFaeVf5ME6pta0j44OfAc01'
            };

            const selectedLink = paymentLinks[userState.selectedPlan];
            
            // Redirect to Stripe payment page
            // After payment, Stripe will redirect back to your app
            window.location.href = selectedLink;
            
            // Note: After successful payment, detect ?success=true in URL
            // and activate premium status
        }

        async function generateReading() {
            const zodiac = document.getElementById('zodiac').value;
            
            if (!zodiac) {
                alert('Please select your zodiac sign');
                return;
            }

            // Check reading limits for free users
            if (!userState.isPremium) {
                if (userState.readingsToday >= userState.maxFreeReadings) {
                    showUpgradeModal();
                    return;
                }
            }

            // Validate based on reading type
            if (selectedReadingType === 'mood' && !selectedMood) {
                alert('Please select your current mood');
                return;
            }

            if (selectedReadingType === 'event') {
                const eventType = document.getElementById('eventType').value;
                if (!eventType) {
                    alert('Please select your event type');
                    return;
                }
            }

            if (selectedReadingType === 'compatibility') {
                const compatSign = document.getElementById('compatibilitySign').value;
                if (!compatSign) {
                    alert('Please select the other person\'s zodiac sign');
                    return;
                }
            }

            if (selectedReadingType === 'relationship' || selectedReadingType === 'sync') {
                const partnerSign = document.getElementById('partnerZodiac').value;
                if (!partnerSign) {
                    alert('Please select your partner\'s zodiac sign');
                    return;
                }
            }

            const btn = document.getElementById('generateBtn');
            btn.disabled = true;
            btn.textContent = 'Consulting the Stars...';

            const resultsDiv = document.getElementById('results');
            resultsDiv.style.display = 'block';

            try {
                const data = zodiacData[zodiac];
                
                document.getElementById('signTitle').textContent = `${data.symbol} ${data.name}`;
                
                document.getElementById('cardDisplay').innerHTML = `
                    <div class="card-display">
                        <div class="symbol">${data.symbol}</div>
                        <div class="name">${data.name}</div>
                        <div class="element">${data.element} Sign | Ruled by ${data.planet}</div>
                    </div>
                `;
                
                let reading;
                
                // Use AI for premium features via backend
                if (userState.isPremium && 
                    (selectedReadingType === 'compatibility' || 
                     selectedReadingType === 'sync' || 
                     selectedReadingType === 'relationship')) {
                    reading = await getAIReading(data);
                } else {
                    // Use pre-written content for free tier
                    reading = getPreWrittenReading(data);
                }
                
                document.getElementById('horoscopeText').innerHTML = `<div class="horoscope-text">${reading}</div>`;

                // Update usage
                if (!userState.isPremium) {
                    userState.readingsToday++;
                    saveUserState();
                    updateUI();
                }

                resultsDiv.scrollIntoView({ behavior: 'smooth' });
                
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('horoscopeText').innerHTML = 
                    '<div class="alert-box warning">Unable to generate reading. Please try again.</div>';
            } finally {
                btn.disabled = false;
                btn.textContent = 'Reveal Your Reading';
            }
        }

        async function getAIReading(data) {
            const prompt = buildAIPrompt(data);
            
            try {
                // Call your Netlify function instead of Anthropic API directly
                const response = await fetch("/.netlify/functions/generate-reading", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        prompt: prompt
                    })
                });

                if (!response.ok) {
                    throw new Error('API request failed');
                }

                const result = await response.json();
                return result.content[0].text;
                
            } catch (error) {
                console.error('AI API Error:', error);
                return getPreWrittenReading(data) + '\n\n<em style="color: #ffc107;">Note: AI service temporarily unavailable, showing enhanced reading.</em>';
            }
        }

        function buildAIPrompt(data) {
            const sign = data.name;
            
            if (selectedReadingType === 'compatibility') {
                const compatSign = document.getElementById('compatibilitySign').value;
                const compatData = zodiacData[compatSign];
                const relType = document.getElementById('relationshipType').value;
                
                return `Generate a quick compatibility snapshot for ${sign} and ${compatData.name} as ${relType}. Include: compatibility score /10, top 3 strengths, top 2 challenges, communication tip, and conflict timing alert for this week. Keep it 200-250 words, practical and insightful.`;
            } else if (selectedReadingType === 'sync') {
                const partnerSign = document.getElementById('partnerZodiac').value;
                const partnerData = zodiacData[partnerSign];
                
                return `Generate a weekly relationship sync calendar (Jan 27-Feb 2, 2026) for ${sign} and ${partnerData.name}. Include: overall weekly energy rating, day-by-day ratings (Mon-Sun), conflict timing alerts (specific days/times to avoid tough talks), best days for deep talks/fun/intimacy/decisions, weekly challenge, weekly opportunity, and a relationship ritual suggestion. Keep it 300-350 words, specific and actionable.`;
            } else if (selectedReadingType === 'relationship') {
                const partnerSign = document.getElementById('partnerZodiac').value;
                const partnerData = zodiacData[partnerSign];
                
                return `Generate a deep relationship report for ${sign} and ${partnerData.name}. Include: overall compatibility score, emotional compatibility breakdown, communication styles and strategies, conflict resolution techniques, long-term potential, 3-month forecast, and specific action steps. Keep it 400-450 words, balanced and actionable.`;
            }
            
            return `Generate a daily horoscope for ${sign}.`;
        }

        function getPreWrittenReading(data) {
            const readings = {
                daily: `Today's energy aligns beautifully with your ${data.name} nature! Your ${data.element} sign is feeling especially empowered. ${data.planet}'s influence brings clarity to your path.

This is an excellent day for ${data.element === 'Fire' ? 'taking bold action and pursuing your passions' : data.element === 'Earth' ? 'practical planning and building solid foundations' : data.element === 'Air' ? 'communication, learning, and social connections' : 'emotional healing and deep connections'}.

In relationships, your ${data.name} authenticity shines through. Career-wise, your natural strengths are highlighted. Trust your instincts when making important decisions.

Lucky color: ${data.element === 'Fire' ? 'Red' : data.element === 'Earth' ? 'Green' : data.element === 'Air' ? 'Yellow' : 'Blue'} | Power number: ${Math.floor(Math.random() * 9) + 1}`,

                mood: `I see you're feeling ${selectedMood}, dear ${data.name}. Your ${data.element} nature helps you process this by ${data.element === 'Fire' ? 'channeling it into action' : data.element === 'Earth' ? 'grounding yourself in practical steps' : data.element === 'Air' ? 'understanding it intellectually' : 'feeling it deeply and allowing healing'}.

This emotional state is temporary, and your ${data.name} strength will guide you through. Focus on ${selectedMood === 'anxious' ? 'breathing and taking one step at a time' : selectedMood === 'motivated' ? 'channeling this energy into your goals' : selectedMood === 'heartbroken' ? 'being gentle with yourself' : 'maintaining this positive state'}.

Today's mantra: "I honor my feelings and trust my journey." ‚ú®`,

                event: `${data.name}, the stars align for your upcoming event! Your ${data.element} energy gives you ${data.element === 'Fire' ? 'bold confidence' : data.element === 'Earth' ? 'steady presence' : data.element === 'Air' ? 'clear communication' : 'emotional intelligence'}.

Your ${data.name} superpower: ${data.name === 'Aries' ? 'Direct authenticity' : data.name === 'Taurus' ? 'Reliable strength' : data.name === 'Gemini' ? 'Adaptable wit' : data.name === 'Cancer' ? 'Emotional warmth' : data.name === 'Leo' ? 'Magnetic confidence' : data.name === 'Virgo' ? 'Thoughtful precision' : data.name === 'Libra' ? 'Graceful diplomacy' : data.name === 'Scorpio' ? 'Intense focus' : data.name === 'Sagittarius' ? 'Infectious optimism' : data.name === 'Capricorn' ? 'Professional maturity' : data.name === 'Aquarius' ? 'Unique perspective' : 'Intuitive connection'}

Power mantra: "I am prepared and capable." Trust yourself! ‚ú®`
            };

            return readings[selectedReadingType] || readings.daily;
        }

        // Initialize on load
        window.addEventListener('load', init);
    </script>
</body>
</html>
